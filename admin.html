<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Paneli - Site Yönetimi</title>
  <style>
    :root {
      --bg-color: #020617;
      --text-color: #e5e7eb;
      --card-bg: rgba(15, 23, 42, 0.92);
      --card-border: rgba(148, 163, 184, 0.45);
      --button-bg: #6366f1;
      --button-text: #f9fafb;
      --input-bg: #020617;
      --input-border: rgba(148, 163, 184, 0.8);
      --muted-text: #9ca3af;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      /* yıldızlı arka plan */
      background-image:
        radial-gradient(1px 1px at 10px 20px, rgba(255,255,255,0.7), transparent 50%),
        radial-gradient(1px 1px at 40px 60px, rgba(255,255,255,0.4), transparent 50%),
        radial-gradient(1.2px 1.2px at 130px 80px, rgba(255,255,255,0.5), transparent 50%),
        radial-gradient(2px 2px at 200px 120px, rgba(255,255,255,0.8), transparent 50%),
        radial-gradient(1px 1px at 250px 200px, rgba(255,255,255,0.6), transparent 50%);
      background-size: 250px 250px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(15, 23, 42, 0.95);
      box-shadow: 0 2px 18px rgba(0, 0, 0, 0.6);
    }

    header h1 {
      margin: 0;
      font-size: 22px;
    }

    header button {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      background: var(--button-bg);
      color: var(--button-text);
      cursor: pointer;
      font-size: 13px;
    }

    main {
      flex: 1;
      width: 95%;
      max-width: 1100px;
      margin: 20px auto 30px;
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 20px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 18px 18px 16px;
      box-shadow:
        0 16px 32px rgba(15, 23, 42, 0.9),
        0 0 0 1px var(--card-border);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .card h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 13px;
      margin-bottom: 8px;
      outline: none;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #a855f7;
      box-shadow: 0 0 0 1px rgba(168, 85, 247, 0.7);
    }

    button.primary {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      background: var(--button-bg);
      color: var(--button-text);
      cursor: pointer;
      font-size: 13px;
      margin-top: 4px;
    }

    button.secondary {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: transparent;
      color: var(--muted-text);
      cursor: pointer;
      font-size: 13px;
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      text-align: left;
      vertical-align: middle;
    }

    th {
      font-weight: 600;
      font-size: 12px;
      opacity: 0.85;
    }

    tbody tr:hover {
      background: rgba(15, 23, 42, 0.4);
    }

    .actions button {
      padding: 4px 8px;
      font-size: 11px;
      margin-right: 4px;
    }

    .status-msg {
      margin-top: 6px;
      font-size: 12px;
      min-height: 16px;
      color: var(--muted-text);
      white-space: pre-wrap;
    }

    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<header>
  <h1>Admin Paneli</h1>
  <button onclick="logout()">Çıkış</button>
</header>

<main>
  <!-- Sol: Kullanıcı ekleme + liste -->
  <section class="card">
    <h2>Kullanıcı Ekle</h2>
    <input id="nameInput" placeholder="Ad Soyad">
    <input id="emailInput" placeholder="E-posta">
    <button class="primary" id="addUserBtn">Ekle</button>
    <div class="status-msg" id="formStatus"></div>

    <hr style="margin:14px 0; opacity:0.3; border-color:var(--card-border);">

    <h2>Kullanıcılar</h2>
    <table>
      <thead>
        <tr>
          <th>Ad</th>
          <th>E-posta</th>
          <th>Anahtar</th>
          <th>İşlem</th>
        </tr>
      </thead>
      <tbody id="userTableBody"></tbody>
    </table>
  </section>

  <!-- Sağ: Seçilen kullanıcıyı düzenle -->
  <section class="card">
    <h2>Seçili Kullanıcıyı Düzenle</h2>
    <div id="editInfo" style="font-size:12px;color:var(--muted-text);margin-bottom:8px;">
      Henüz kullanıcı seçilmedi.
    </div>

    <div id="editSection" style="display:none;">
      <input id="editName" placeholder="Ad Soyad">
      <input id="editEmail" placeholder="E-posta">
      <input id="editPhone" placeholder="Telefon">
      <input id="editWebsite" placeholder="Web Site">
      <textarea id="editAddress" placeholder="Dükkan Adresi"></textarea>
      <input id="editVisitors" type="number" min="0" placeholder="Toplam Ziyaretçi">
      <input id="editSessions" type="number" min="0" placeholder="Aktif Oturum">

      <button class="primary" id="saveEditBtn">Kaydet</button>
      <button class="secondary" id="cancelEditBtn">İptal</button>

      <div class="status-msg" id="editStatus"></div>
    </div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    getDoc,
    doc,
    updateDoc,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBlaglZNm3X2jQRrOPNA9Q6D3nCvjG5VjU",
    authDomain: "nrussystem.firebaseapp.com",
    projectId: "nrussystem",
    storageBucket: "nrussystem.firebasestorage.app",
    messagingSenderId: "907157259049",
    appId: "1:907157259049:web:7a4f4b547803345ce92d38"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // DOM referansları
  const nameInput      = document.getElementById('nameInput');
  const emailInput     = document.getElementById('emailInput');
  const addUserBtn     = document.getElementById('addUserBtn');
  const formStatus     = document.getElementById('formStatus');
  const userTableBody  = document.getElementById('userTableBody');

  const editSection    = document.getElementById('editSection');
  const editInfo       = document.getElementById('editInfo');
  const editName       = document.getElementById('editName');
  const editEmail      = document.getElementById('editEmail');
  const editPhone      = document.getElementById('editPhone');
  const editWebsite    = document.getElementById('editWebsite');
  const editAddress    = document.getElementById('editAddress');
  const editVisitors   = document.getElementById('editVisitors');
  const editSessions   = document.getElementById('editSessions');
  const saveEditBtn    = document.getElementById('saveEditBtn');
  const cancelEditBtn  = document.getElementById('cancelEditBtn');
  const editStatus     = document.getElementById('editStatus');

  let currentEditId = null;

  function generateAccessKey(length = 8) {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let key = '';
    for (let i = 0; i < length; i++) {
      key += chars[Math.floor(Math.random() * chars.length)];
    }
    return key;
  }

  function setFormStatus(msg, isError = false) {
    formStatus.style.color = isError ? '#fecaca' : '#9ca3af';
    formStatus.textContent = msg || '';
  }

  function setEditStatus(msg, isError = false) {
    editStatus.style.color = isError ? '#fecaca' : '#9ca3af';
    editStatus.textContent = msg || '';
  }

  addUserBtn.addEventListener('click', async () => {
    const name  = nameInput.value.trim();
    const email = emailInput.value.trim();
    if (!name || !email) {
      setFormStatus('Lütfen ad ve e-posta girin.', true);
      return;
    }

    setFormStatus('Kullanıcı ekleniyor...');

    try {
      const accessKey = generateAccessKey();
      await addDoc(collection(db, 'users'), {
        name,
        email,
        role: 'user',
        accessKey,
        phone: '',
        website: '',
        address: '',
        totalVisitors: 0,
        activeSessions: 0
      });

      nameInput.value = '';
      emailInput.value = '';
      setFormStatus(`Kullanıcı eklendi. Anahtar: ${accessKey}`);
      await loadUsers();
    } catch (err) {
      console.error(err);
      setFormStatus('Kullanıcı eklenirken hata oluştu.', true);
    }
  });

  async function loadUsers() {
    userTableBody.innerHTML = '';
    try {
      const snap = await getDocs(collection(db, 'users'));
      snap.forEach(docSnap => {
        const u = docSnap.data();
        const tr = document.createElement('tr');
        tr.dataset.id = docSnap.id;
        tr.innerHTML = `
          <td>${u.name || ''}</td>
          <td>${u.email || ''}</td>
          <td>${u.accessKey || ''}</td>
          <td class="actions">
            <button class="edit-btn">Düzenle</button>
            <button class="delete-btn">Sil</button>
          </td>
        `;
        userTableBody.appendChild(tr);
      });
    } catch (err) {
      console.error('Kullanıcıları çekerken hata:', err);
    }
  }

  userTableBody.addEventListener('click', async (e) => {
    const btn = e.target;
    const tr = btn.closest('tr');
    if (!tr) return;
    const id = tr.dataset.id;
    if (!id) return;

    if (btn.classList.contains('edit-btn')) {
      await startEditUser(id);
    } else if (btn.classList.contains('delete-btn')) {
      if (!confirm('Bu kullanıcı silinsin mi?')) return;
      try {
        await deleteDoc(doc(db, 'users', id));
        if (currentEditId === id) {
          currentEditId = null;
          editSection.style.display = 'none';
          editInfo.textContent = 'Henüz kullanıcı seçilmedi.';
        }
        await loadUsers();
      } catch (err) {
        console.error(err);
        alert('Silinirken hata oluştu.');
      }
    }
  });

  async function startEditUser(id) {
    try {
      const ref = doc(db, 'users', id);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        alert('Kullanıcı bulunamadı.');
        return;
      }
      const u = snap.data();
      currentEditId = id;
      editName.value     = u.name || '';
      editEmail.value    = u.email || '';
      editPhone.value    = u.phone || '';
      editWebsite.value  = u.website || '';
      editAddress.value  = u.address || '';
      editVisitors.value = u.totalVisitors || 0;
      editSessions.value = u.activeSessions || 0;

      editInfo.textContent = `Düzenlenen kullanıcı: ${u.name || ''} (${u.accessKey || ''})`;
      editSection.style.display = 'block';
      setEditStatus('');
    } catch (err) {
      console.error(err);
      alert('Kullanıcı yüklenirken hata oluştu.');
    }
  }

  saveEditBtn.addEventListener('click', async () => {
    if (!currentEditId) {
      setEditStatus('Önce bir kullanıcı seçin.', true);
      return;
    }

    const name     = editName.value.trim();
    const email    = editEmail.value.trim();
    const phone    = editPhone.value.trim();
    const website  = editWebsite.value.trim();
    const address  = editAddress.value.trim();
    const visitors = parseInt(editVisitors.value) || 0;
    const sessions = parseInt(editSessions.value) || 0;

    setEditStatus('Kaydediliyor...');

    try {
      const ref = doc(db, 'users', currentEditId);
      await updateDoc(ref, {
        name,
        email,
        phone,
        website,
        address,
        totalVisitors: visitors,
        activeSessions: sessions
      });

      setEditStatus('Kayıt güncellendi.');
      await loadUsers();
    } catch (err) {
      console.error(err);
      setEditStatus('Güncellerken hata oluştu.', true);
    }
  });

  cancelEditBtn.addEventListener('click', () => {
    currentEditId = null;
    editSection.style.display = 'none';
    editInfo.textContent = 'Henüz kullanıcı seçilmedi.';
    setEditStatus('');
  });

  // Login kontrol (isteğe bağlı – admin de key ile giriyorsa burada role check yapabilirsin)
  try {
    const raw = localStorage.getItem('currentUser');
    if (!raw) {
      window.location.href = 'index.html';
    } else {
      const u = JSON.parse(raw);
      if (u.role !== 'admin') {
        window.location.href = 'user.html';
      }
    }
  } catch (e) {
    console.error(e);
    window.location.href = 'index.html';
  }

  window.logout = () => {
    try { localStorage.removeItem('currentUser'); } catch (e) {}
    window.location.href = 'index.html';
  };

  // İlk yükleme
  loadUsers();
</script>

</body>
</html>
