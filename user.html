<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KullanÄ±cÄ± Paneli</title>
  <style>
    :root {
      --bg-color: #020617;
      --text-color: #e5e7eb;
      --sidebar-bg: rgba(15, 23, 42, 0.96);
      --card-bg: rgba(15, 23, 42, 0.92);
      --card-border: rgba(148, 163, 184, 0.45);
      --button-bg: #6366f1;
      --button-text: #f9fafb;
      --bar-bg: #111827;
      --muted-text: #9ca3af;
    }

    .light-theme {
      --bg-color: #eef2ff;
      --text-color: #111827;
      --sidebar-bg: rgba(255, 255, 255, 0.96);
      --card-bg: rgba(255, 255, 255, 0.96);
      --card-border: #e5e7eb;
      --button-bg: #4f46e5;
      --button-text: #f9fafb;
      --bar-bg: #e5e7eb;
      --muted-text: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: var(--bg-color);
      /* daha fazla yÄ±ldÄ±z */
      background-image:
        radial-gradient(1px 1px at 10px 20px, rgba(255,255,255,0.8), transparent 50%),
        radial-gradient(1px 1px at 40px 60px, rgba(255,255,255,0.6), transparent 50%),
        radial-gradient(1.2px 1.2px at 130px 80px, rgba(255,255,255,0.7), transparent 50%),
        radial-gradient(1.5px 1.5px at 200px 120px, rgba(255,255,255,0.9), transparent 50%),
        radial-gradient(1px 1px at 250px 200px, rgba(255,255,255,0.7), transparent 50%),
        radial-gradient(1px 1px at 80px 180px, rgba(255,255,255,0.5), transparent 50%),
        radial-gradient(1px 1px at 180px 30px, rgba(255,255,255,0.6), transparent 50%),
        radial-gradient(1.2px 1.2px at 300px 220px, rgba(255,255,255,0.8), transparent 50%),
        radial-gradient(1px 1px at 320px 40px, rgba(255,255,255,0.5), transparent 50%);
      background-size: 260px 260px;
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      transition: 0.4s;
    }

    body.light-theme {
      background-color: #eef2ff;
      background-image: none;
    }

    .sidebar {
      width: 230px;
      background: var(--sidebar-bg);
      padding: 20px 15px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 4px 0 20px rgba(15, 23, 42, 0.9);
    }

    .sidebar-logo {
      font-weight: bold;
      font-size: 18px;
    }

    .sidebar-sub {
      font-size: 12px;
      opacity: 0.8;
    }

    .sidebar-controls {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .sidebar button {
      padding: 6px 10px;
      border: none;
      border-radius: 999px;
      background: var(--button-bg);
      color: var(--button-text);
      cursor: pointer;
      font-size: 13px;
      transition: 0.3s;
    }

    .sidebar button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.9);
    }

    .lang-btn {
      font-size: 18px;
    }

    .menu {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .menu-item {
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0.85;
      transition: 0.25s;
    }

    .menu-item span.icon {
      width: 20px;
      text-align: center;
    }

    .menu-item:hover {
      background: rgba(148, 163, 184, 0.25);
      opacity: 1;
    }

    .menu-item.active {
      background: var(--button-bg);
      color: var(--button-text);
      opacity: 1;
    }

    .menu-footer {
      margin-top: auto;
      font-size: 11px;
      opacity: 0.7;
    }

    .content {
      flex: 1;
      padding: 25px 30px;
      display: flex;
      flex-direction: column;
    }

    header h1 {
      margin: 0 0 6px 0;
      font-size: 24px;
    }

    header p {
      margin: 0;
      opacity: 0.85;
      font-size: 14px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 18px 18px 16px;
      box-shadow:
        0 16px 32px rgba(15, 23, 42, 0.9),
        0 0 0 1px var(--card-border);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .card h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }

    .card h2 span.badge {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      color: var(--muted-text);
      margin-left: 6px;
    }

    .card p {
      margin: 0;
      opacity: 0.9;
      font-size: 13px;
    }

    .status-section {
      max-width: 700px;
      margin-top: 8px;
    }

    .status-section h2 {
      margin-bottom: 15px;
      font-size: 20px;
    }

    .status-row {
      margin-bottom: 18px;
    }

    .status-label-line {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 6px;
    }

    .status-label-left { opacity: 0.9; }
    .status-label-right { opacity: 0.7; font-family: monospace; }

    .status-bar-outer {
      width: 100%;
      height: 12px;
      border-radius: 999px;
      background: var(--bar-bg);
      overflow: hidden;
    }

    .status-bar-inner {
      height: 100%;
      width: 99.9%;
      background: linear-gradient(90deg, #22c55e, #4ade80);
      border-radius: 999px;
    }

    .form-group {
      margin-bottom: 10px;
      font-size: 13px;
    }

    .form-group label {
      display: block;
      margin-bottom: 4px;
    }

    .form-group select,
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: var(--card-bg);
      color: var(--text-color);
      outline: none;
      font-size: 13px;
      resize: vertical;
    }

    .form-group select:focus,
    .form-group input:focus,
    .form-group textarea:focus {
      border-color: #a855f7;
      box-shadow: 0 0 0 1px rgba(168, 85, 247, 0.7);
    }

    .request-actions {
      margin-top: 10px;
      text-align: right;
    }

    .request-actions button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: var(--button-bg);
      color: var(--button-text);
      cursor: pointer;
      font-size: 13px;
    }

    .request-status-msg {
      margin-top: 8px;
      font-size: 13px;
      min-height: 16px;
    }

    .request-status-msg.success { color: #bbf7d0; }
    .request-status-msg.error   { color: #fecaca; }

    .request-section {
      display: none;
      margin-top: 8px;
    }

    .request-section.active {
      display: block;
    }

    .request-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 12px;
    }

    .request-table th,
    .request-table td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
    }

    .request-summary {
      max-width: 260px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    footer {
      margin-top: auto;
      padding-top: 20px;
      font-size: 11px;
      opacity: 0.7;
      text-align: center;
    }

    @media (max-width: 768px) {
      .sidebar { width: 210px; }
    }
  </style>
</head>
<body>

<aside class="sidebar">
  <div>
    <div class="sidebar-logo" id="logoText">ğŸ‘¤ KullanÄ±cÄ± Paneli</div>
    <div class="sidebar-sub" id="logoSubText">Site yÃ¶netim istekleri buradan gÃ¶nderilir</div>

    <div class="sidebar-controls">
      <button id="langBtn" class="lang-btn">ğŸ‡¹ğŸ‡· / ğŸ‡¬ğŸ‡§</button>
      <button id="themeBtn">Tema</button>
    </div>
  </div>

  <nav class="menu">
    <div class="menu-item active">
      <span class="icon">ğŸ </span>
      <span id="menuDashboard">Panel</span>
    </div>
    <div class="menu-item">
      <span class="icon">ğŸ‘¤</span>
      <span id="menuProfile">Profilim</span>
    </div>
    <div class="menu-item">
      <span class="icon">ğŸšª</span>
      <span id="menuLogout">Ã‡Ä±kÄ±ÅŸ</span>
    </div>
  </nav>

  <div class="menu-footer">
    Bu panel, ana sitenizin yÃ¶netim isteklerini adminâ€™e iletmek iÃ§in kullanÄ±lÄ±r.
  </div>
</aside>

<div class="content">
  <header>
    <h1 id="userTitle" data-lang="tr">HoÅŸ geldiniz!</h1>
    <p id="userSubtitle">Bu panelden siteniz iÃ§in yÃ¶netim istekleri gÃ¶nderebilirsiniz.</p>
  </header>

  <!-- Ã–zet kartlar (istatistikler) -->
  <section class="cards">
    <div class="card">
      <h2 id="card1Title">Site Ä°statistikleri <span class="badge">Ã–zet</span></h2>
      <p id="card1Text">BugÃ¼nkÃ¼ ziyaretÃ§i, toplam ziyaretÃ§i, kayÄ±tlÄ± kullanÄ±cÄ± ve oturum bilgilerini adminâ€™e iletebilirsiniz.</p>
    </div>
    <div class="card">
      <h2 id="card2Title">Duyuru & BakÄ±m</h2>
      <p id="card2Text">Yeni duyuru yayÄ±nlama veya bakÄ±m modunu aÃ§/kapatma isteÄŸi gÃ¶nderebilirsiniz.</p>
    </div>
    <div class="card">
      <h2 id="card3Title">Ä°stek Takibi</h2>
      <p id="card3Text">GÃ¶nderdiÄŸiniz site yÃ¶netim isteklerinin durumlarÄ±nÄ± aÅŸaÄŸÄ±dan takip edin.</p>
    </div>
  </section>

  <!-- StatÃ¼ barlarÄ± (sistemin genel durumu, gÃ¶rsel) -->
  <section class="status-section">
    <h2 id="statusTitle">StatÃ¼ Durumu</h2>

    <div class="status-row">
      <div class="status-label-line">
        <span class="status-label-left" id="status1Label">Sunucu</span>
        <span class="status-label-right">99.9%</span>
      </div>
      <div class="status-bar-outer"><div class="status-bar-inner"></div></div>
    </div>

    <div class="status-row">
      <div class="status-label-line">
        <span class="status-label-left" id="status2Label">BaÄŸlantÄ±</span>
        <span class="status-label-right">99.9%</span>
      </div>
      <div class="status-bar-outer"><div class="status-bar-inner"></div></div>
    </div>

    <div class="status-row">
      <div class="status-label-line">
        <span class="status-label-left" id="status3Label">VeritabanÄ±</span>
        <span class="status-label-right">99.9%</span>
      </div>
      <div class="status-bar-outer"><div class="status-bar-inner"></div></div>
    </div>
  </section>

  <!-- Site YÃ¶netim Ä°steÄŸi Formu -->
  <section class="card" style="max-width: 720px; margin-top:25px;">
    <h2>Site YÃ¶netim Ä°steÄŸi <span class="badge">Yeni Ä°stek</span></h2>

    <div class="form-group">
      <label for="requestType">Ä°stek Tipi</label>
      <select id="requestType">
        <option value="">SeÃ§iniz...</option>
        <option value="stats">Ä°statistik GÃ¼ncelleme</option>
        <option value="announcement">Yeni Duyuru YayÄ±nla</option>
        <option value="maintenance">BakÄ±m Modu AÃ§/Kapat</option>
      </select>
    </div>

    <!-- Ä°statistik GÃ¼ncelleme -->
    <div id="requestStatsSection" class="request-section">
      <div class="form-group">
        <label for="visitorsToday">BugÃ¼nkÃ¼ ziyaretÃ§i sayÄ±sÄ±</label>
        <input id="visitorsToday" type="number" min="0" placeholder="Ã–rn: 123">
      </div>
      <div class="form-group">
        <label for="visitorsTotal">Toplam ziyaretÃ§i</label>
        <input id="visitorsTotal" type="number" min="0" placeholder="Ã–rn: 8450">
      </div>
      <div class="form-group">
        <label for="totalUsers">Toplam kayÄ±tlÄ± kullanÄ±cÄ±</label>
        <input id="totalUsers" type="number" min="0" placeholder="Ã–rn: 320">
      </div>
      <div class="form-group">
        <label for="activeSessions">Aktif oturum sayÄ±sÄ±</label>
        <input id="activeSessions" type="number" min="0" placeholder="Ã–rn: 12">
      </div>
      <div class="form-group">
        <label for="lastDeploy">Son deploy tarihi (tarih / saat)</label>
        <input id="lastDeploy" type="text" placeholder="Ã–rn: 12.12.2025 14:32">
      </div>
    </div>

    <!-- Yeni Duyuru -->
    <div id="requestAnnouncementSection" class="request-section">
      <div class="form-group">
        <label for="announcementTitle">Duyuru baÅŸlÄ±ÄŸÄ±</label>
        <input id="announcementTitle" type="text" placeholder="Ã–rn: Yeni sÃ¼rÃ¼m yayÄ±nda!">
      </div>
      <div class="form-group">
        <label for="announcementMessage">Duyuru metni</label>
        <textarea id="announcementMessage" rows="3" placeholder="KullanÄ±cÄ±lara gÃ¶sterilecek duyuru metni..."></textarea>
      </div>
    </div>

    <!-- BakÄ±m Modu -->
    <div id="requestMaintenanceSection" class="request-section">
      <div class="form-group">
        <label for="maintenanceMode">BakÄ±m modu durumu</label>
        <select id="maintenanceMode">
          <option value="">SeÃ§iniz...</option>
          <option value="open">BakÄ±m Modunu AÃ§</option>
          <option value="close">BakÄ±m Modunu Kapat</option>
        </select>
      </div>
      <div class="form-group">
        <label for="maintenanceNote">Not (isteÄŸe baÄŸlÄ±)</label>
        <textarea id="maintenanceNote" rows="2" placeholder="Ã–rn: 01:00 - 03:00 arasÄ±nda bakÄ±m planlanÄ±yor."></textarea>
      </div>
    </div>

    <div class="request-actions">
      <button id="requestSendBtn">Ä°stek GÃ¶nder</button>
    </div>

    <div id="requestStatusMsg" class="request-status-msg"></div>
  </section>

  <!-- GÃ¶nderilen Ä°stekler Tablosu -->
  <section class="card" style="max-width: 900px; margin-top:20px;">
    <h2>Ä°steklerim <span class="badge">Durum Takibi</span></h2>
    <table class="request-table">
      <thead>
        <tr>
          <th>Tip</th>
          <th>AÃ§Ä±klama</th>
          <th>Durum</th>
          <th>Tarih</th>
        </tr>
      </thead>
      <tbody id="requestTableBody"></tbody>
    </table>
  </section>

  <footer>
    Â© 2025 Site YÃ¶netim Paneli â€“ TÃ¼m istekler admin tarafÄ±na iletilir ve Firestoreâ€™da saklanÄ±r.
  </footer>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBlaglZNm3X2jQRrOPNA9Q6D3nCvjG5VjU",
    authDomain: "nrussystem.firebaseapp.com",
    projectId: "nrussystem",
    storageBucket: "nrussystem.firebasestorage.app",
    messagingSenderId: "907157259049",
    appId: "1:907157259049:web:7a4f4b547803345ce92d38",
    measurementId: "G-95XV7GLF6P"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // Login kontrolÃ¼
  let currentUser = null;
  try {
    const raw = localStorage.getItem('currentUser');
    if (!raw) window.location.href = 'index.html';
    else currentUser = JSON.parse(raw);
  } catch (e) {
    console.error(e);
    window.location.href = 'index.html';
  }

  // DOM referanslarÄ±
  const themeBtn   = document.getElementById('themeBtn');
  const langBtn    = document.getElementById('langBtn');
  const logoText   = document.getElementById('logoText');
  const logoSubText= document.getElementById('logoSubText');
  const userTitle    = document.getElementById('userTitle');
  const userSubtitle = document.getElementById('userSubtitle');

  const card1Title = document.getElementById('card1Title');
  const card1Text  = document.getElementById('card1Text');
  const card2Title = document.getElementById('card2Title');
  const card2Text  = document.getElementById('card2Text');
  const card3Title = document.getElementById('card3Title');
  const card3Text  = document.getElementById('card3Text');

  const statusTitle  = document.getElementById('statusTitle');
  const status1Label = document.getElementById('status1Label');
  const status2Label = document.getElementById('status2Label');
  const status3Label = document.getElementById('status3Label');

  const menuDashboard = document.getElementById('menuDashboard');
  const menuProfile   = document.getElementById('menuProfile');
  const menuLogout    = document.getElementById('menuLogout');

  const requestTypeSelect = document.getElementById('requestType');
  const requestStatsSection        = document.getElementById('requestStatsSection');
  const requestAnnouncementSection = document.getElementById('requestAnnouncementSection');
  const requestMaintenanceSection  = document.getElementById('requestMaintenanceSection');

  const visitorsTodayInput   = document.getElementById('visitorsToday');
  const visitorsTotalInput   = document.getElementById('visitorsTotal');
  const totalUsersInput      = document.getElementById('totalUsers');
  const activeSessionsInput  = document.getElementById('activeSessions');
  const lastDeployInput      = document.getElementById('lastDeploy');

  const announcementTitleInput   = document.getElementById('announcementTitle');
  const announcementMessageInput = document.getElementById('announcementMessage');

  const maintenanceModeSelect = document.getElementById('maintenanceMode');
  const maintenanceNoteInput  = document.getElementById('maintenanceNote');

  const requestSendBtn   = document.getElementById('requestSendBtn');
  const requestStatusMsg = document.getElementById('requestStatusMsg');

  const requestTableBody = document.getElementById('requestTableBody');

  if (currentUser && currentUser.name) {
    userTitle.textContent = `HoÅŸ geldiniz, ${currentUser.name}!`;
  }

  function getLang() {
    return userTitle.getAttribute('data-lang') || 'tr';
  }

  themeBtn.addEventListener('click', () => {
    document.body.classList.toggle('light-theme');
  });

  langBtn.addEventListener('click', () => {
    const currentLang = userTitle.getAttribute('data-lang');

    if (currentLang === 'tr') {
      userTitle.textContent     = currentUser && currentUser.name
        ? `Welcome, ${currentUser.name}!`
        : 'Welcome!';
      userSubtitle.textContent  = 'You can send site management requests to the admin using this panel.';
      logoText.textContent      = 'ğŸ‘¤ User Panel';
      logoSubText.textContent   = 'Send management requests for your site';

      card1Title.textContent    = 'Site Statistics';
      card1Text.textContent     = 'You can send today/total visitors, registered users and sessions info to the admin.';
      card2Title.textContent    = 'Announcement & Maintenance';
      card2Text.textContent     = 'Request new announcement or toggle maintenance mode.';
      card3Title.textContent    = 'Request Tracking';
      card3Text.textContent     = 'Track the status of your site management requests below.';

      statusTitle.textContent   = 'Status';
      status1Label.textContent  = 'Server';
      status2Label.textContent  = 'Connection';
      status3Label.textContent  = 'Database';

      menuDashboard.textContent = 'Dashboard';
      menuProfile.textContent   = 'Profile';
      menuLogout.textContent    = 'Logout';

      userTitle.setAttribute('data-lang', 'en');
      langBtn.innerHTML = 'ğŸ‡¬ğŸ‡§ / ğŸ‡¹ğŸ‡·';
    } else {
      userTitle.textContent     = currentUser && currentUser.name
        ? `HoÅŸ geldiniz, ${currentUser.name}!`
        : 'HoÅŸ geldiniz!';
      userSubtitle.textContent  = 'Bu panelden siteniz iÃ§in yÃ¶netim istekleri gÃ¶nderebilirsiniz.';
      logoText.textContent      = 'ğŸ‘¤ KullanÄ±cÄ± Paneli';
      logoSubText.textContent   = 'Site yÃ¶netim istekleri buradan gÃ¶nderilir';

      card1Title.textContent    = 'Site Ä°statistikleri';
      card1Text.textContent     = 'BugÃ¼nkÃ¼ ziyaretÃ§i, toplam ziyaretÃ§i, kayÄ±tlÄ± kullanÄ±cÄ± ve oturum bilgilerini adminâ€™e iletebilirsiniz.';
      card2Title.textContent    = 'Duyuru & BakÄ±m';
      card2Text.textContent     = 'Yeni duyuru yayÄ±nlama veya bakÄ±m modunu aÃ§/kapatma isteÄŸi gÃ¶nderebilirsiniz.';
      card3Title.textContent    = 'Ä°stek Takibi';
      card3Text.textContent     = 'GÃ¶nderdiÄŸiniz site yÃ¶netim isteklerinin durumlarÄ±nÄ± aÅŸaÄŸÄ±dan takip edin.';

      statusTitle.textContent   = 'StatÃ¼ Durumu';
      status1Label.textContent  = 'Sunucu';
      status2Label.textContent  = 'BaÄŸlantÄ±';
      status3Label.textContent  = 'VeritabanÄ±';

      menuDashboard.textContent = 'Panel';
      menuProfile.textContent   = 'Profilim';
      menuLogout.textContent    = 'Ã‡Ä±kÄ±ÅŸ';

      userTitle.setAttribute('data-lang', 'tr');
      langBtn.innerHTML = 'ğŸ‡¹ğŸ‡· / ğŸ‡¬ğŸ‡§';
    }
  });

  document.querySelectorAll('.menu-item').forEach(item => {
    item.addEventListener('click', () => {
      document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');

      const label = item.querySelector('span:last-child').textContent.trim();
      if (label === 'Ã‡Ä±kÄ±ÅŸ' || label === 'Logout') {
        try { localStorage.removeItem('currentUser'); } catch (e) {}
        window.location.href = 'index.html';
      }
    });
  });

  function setRequestStatus(type, message) {
    requestStatusMsg.classList.remove('success', 'error');
    if (type) requestStatusMsg.classList.add(type);
    requestStatusMsg.textContent = message || '';
  }

  function showRequestSection(type) {
    requestStatsSection.classList.remove('active');
    requestAnnouncementSection.classList.remove('active');
    requestMaintenanceSection.classList.remove('active');

    if (type === 'stats') requestStatsSection.classList.add('active');
    if (type === 'announcement') requestAnnouncementSection.classList.add('active');
    if (type === 'maintenance') requestMaintenanceSection.classList.add('active');
  }

  requestTypeSelect.addEventListener('change', () => {
    showRequestSection(requestTypeSelect.value);
    setRequestStatus('', '');
  });

  requestSendBtn.addEventListener('click', async () => {
    const type = requestTypeSelect.value;
    const lang = getLang();

    if (!type) {
      setRequestStatus('error', lang === 'tr'
        ? 'LÃ¼tfen istek tipini seÃ§in.'
        : 'Please select a request type.');
      return;
    }

    let payload = {};
    if (type === 'stats') {
      const vToday  = visitorsTodayInput.value.trim();
      const vTotal  = visitorsTotalInput.value.trim();
      const tUsers  = totalUsersInput.value.trim();
      const aSess   = activeSessionsInput.value.trim();
      const deploy  = lastDeployInput.value.trim();

      if (!vToday || !vTotal || !tUsers || !aSess || !deploy) {
        setRequestStatus('error', lang === 'tr'
          ? 'LÃ¼tfen tÃ¼m istatistik alanlarÄ±nÄ± doldurun.'
          : 'Please fill all statistics fields.');
        return;
      }

      payload = {
        visitorsToday: vToday,
        visitorsTotal: vTotal,
        totalUsers: tUsers,
        activeSessions: aSess,
        lastDeploy: deploy
      };
    } else if (type === 'announcement') {
      const title = announcementTitleInput.value.trim();
      const msg   = announcementMessageInput.value.trim();
      if (!title || !msg) {
        setRequestStatus('error', lang === 'tr'
          ? 'LÃ¼tfen duyuru baÅŸlÄ±ÄŸÄ± ve metnini doldurun.'
          : 'Please fill announcement title and message.');
        return;
      }
      payload = { title, message: msg };
    } else if (type === 'maintenance') {
      const mode = maintenanceModeSelect.value;
      const note = maintenanceNoteInput.value.trim();
      if (!mode) {
        setRequestStatus('error', lang === 'tr'
          ? 'LÃ¼tfen bakÄ±m modu durumunu seÃ§in.'
          : 'Please select maintenance mode.');
        return;
      }
      payload = { mode, note };
    }

    setRequestStatus('', lang === 'tr'
      ? 'Ä°stek gÃ¶nderiliyor...'
      : 'Sending request...');

    try {
      const now = new Date();
      const createdAt = now.toLocaleString('tr-TR');

      await addDoc(collection(db, 'siteRequests'), {
        userId: currentUser?.id || null,
        userName: currentUser?.name || '',
        userAccessKey: currentUser?.accessKey || '',
        type,
        payload,
        status: 'Beklemede',
        createdAt
      });

      setRequestStatus('success', lang === 'tr'
        ? 'Ä°stek gÃ¶nderildi. Durumu aÅŸaÄŸÄ±daki listeden takip edebilirsiniz.'
        : 'Request sent. You can track it in the list below.');

      // Formu temizle
      if (type === 'stats') {
        visitorsTodayInput.value  = '';
        visitorsTotalInput.value  = '';
        totalUsersInput.value     = '';
        activeSessionsInput.value = '';
        lastDeployInput.value     = '';
      } else if (type === 'announcement') {
        announcementTitleInput.value   = '';
        announcementMessageInput.value = '';
      } else if (type === 'maintenance') {
        maintenanceModeSelect.value = '';
        maintenanceNoteInput.value  = '';
      }
      requestTypeSelect.value = '';
      showRequestSection('');

      await loadMyRequests();
    } catch (err) {
      console.error(err);
      setRequestStatus('error', lang === 'tr'
        ? 'Ä°stek gÃ¶nderilirken bir hata oluÅŸtu.'
        : 'An error occurred while sending the request.');
    }
  });

  function summarizeRequest(docData) {
    const type = docData.type;
    const p = docData.payload || {};
    if (type === 'stats') {
      return `Ziy: ${p.visitorsToday}/${p.visitorsTotal}, KullanÄ±cÄ±: ${p.totalUsers}, Oturum: ${p.activeSessions}`;
    }
    if (type === 'announcement') {
      return `Duyuru: ${p.title || ''}`;
    }
    if (type === 'maintenance') {
      if (p.mode === 'open')  return 'BakÄ±m modunu AÃ‡';
      if (p.mode === 'close') return 'BakÄ±m modunu KAPAT';
      return 'BakÄ±m modu isteÄŸi';
    }
    return '';
  }

  function typeLabel(type, lang) {
    if (lang === 'en') {
      if (type === 'stats')        return 'Stats Update';
      if (type === 'announcement') return 'New Announcement';
      if (type === 'maintenance')  return 'Maintenance';
    } else {
      if (type === 'stats')        return 'Ä°statistik';
      if (type === 'announcement') return 'Duyuru';
      if (type === 'maintenance')  return 'BakÄ±m Modu';
    }
    return type || '-';
  }

  async function loadMyRequests() {
    requestTableBody.innerHTML = '';
    try {
      let q;
      if (currentUser?.id) {
        q = query(collection(db, 'siteRequests'), where('userId', '==', currentUser.id));
      } else if (currentUser?.accessKey) {
        q = query(collection(db, 'siteRequests'), where('userAccessKey', '==', currentUser.accessKey));
      } else {
        return;
      }

      const lang = getLang();
      const snap = await getDocs(q);
      snap.forEach(docSnap => {
        const data = docSnap.data();
        const tr = document.createElement('tr');
        const tLabel = typeLabel(data.type, lang);
        const summary = summarizeRequest(data);

        tr.innerHTML = `
          <td>${tLabel}</td>
          <td><span class="request-summary" title="${summary.replace(/"/g, '&quot;')}">${summary}</span></td>
          <td>${data.status || '-'}</td>
          <td>${data.createdAt || '-'}</td>
        `;
        requestTableBody.appendChild(tr);
      });
    } catch (err) {
      console.error('Ä°stekleri Ã§ekerken hata:', err);
    }
  }

  (async () => {
    await loadMyRequests();
  })();
</script>

</body>
</html>
